<!DOCTYPE html>
<html>

<head>

<title>Canadian Expat Voting System</title>

<meta name="DESCRIPTION" content="Secure authenticated system to enable Canadian citizens living outside the country be able to vote in #elxn42">
<meta name="KEYWORD" content="vote expat canada canadian elxn42 stephen harper justin trudeau tom mulclair elizabeth may">

<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.2.min.js"></script>
<script>
function setCookie(cname,cvalue,exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname+"="+cvalue+"; domain=.expatvote.ca; path=/; "+expires;
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

// function to generate a pseudo-guid (actually could be OK since RFC says we can have random GUIDs)
// in any case, it is good enough for this proof of concept.
function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

</script>

<style>
body {
    margin:0px;
    background:#000;
    background: #8B2942 url('images/world.jpg') top center;
    background-repeat: repeat-y;
}
.header-cont {
    width: 100%;
    /**position: fixed;**/
    top: 0px;
    z-index: 999;
}
.header {
    height: 140px;
    background: #F0F0F0;
    border: 3px solid #8B2942;
    width: 960px;
    margin: 0px auto;
    text-align: center;
    font-size: large;
}
.input {
    width: 960px;
    background: #F0F0F0;
    border: 3px solid #8B2942;
    height: 270px;
    margin: 20px auto;
    font-size: large;
}
.output {
    width: 960px;
    background: #F0F0F0;
    border: 3px solid #8B2942;
    height: 600px;
    margin: 20px auto;
}
.results {
    width: 900px;
    padding-left: 20px;
}
.results p {
    padding-left: 30px;
    font-size: large;
}
.personal {
    width: 400px;
    float: left;
    margin: 20px;
}
.vote {
    width: 200px;
    float: left;
    margin: 20px;
}
</style>

</head>

<body>

  <div class="header-cont">
    <div class="header">
      <h1>Every Canadian has the right to vote; even expats</h1>
      <p>This web application is a prototype of an internet voting system. This will be used for the 2015 to conduct an un-official vote (poll).
    </div>
  </div>

  <div class="input">

    <form id="info">
      <fieldset class="personal">
        <legend>Personal information:</legend>
          Full name:<br>
          <input type="text" name="fullname" id="fullname" maxlength="50" size="50" required placeholder="full legal name">
          <br>
          Email:<br>
          <input type="email" name="email" id="email" maxlength="50" size="50" required placeholder="valid unique email address">
          <br>
          Facebook:<br>
          <input type="text" name="facebook" id="facebook" maxlength="50" size="50" placeholder="omit 'https://www.facebook/com' part">
          <br>
          Twitter:<br>
          <input type="text" name="twitter" id="twitter" maxlength="50" size="50" placeholder="omit 'http://www.twitter.com' part">
        </fieldset>
        <br>
        <br>
        <fieldset class="vote">
          <legend>Vote</legend>
          Party:<br>
          <select name="party" id="party">
            <option value="none">None of the Above</option>
            <option value="conservative">Conservative</option>
            <option value="green">Green</option>
            <option value="liberal">Liberal</option>
            <option value="ndp">NDP</option>
          </select>
          <br>
        </fieldset>
    </form>
    <br>
    <p>
    <button name="Submit" id="submit">Submit</button>
    <button name="Clear" id="clear" style="display: none;">Clear Cookies</button>
  </div>

  <div class="output">
    <div class="results">
      <div>
         <h3>Your Vote</h3>
         <p id="evote"></p>
         <p style="font-size:small">just here to double check; browse to another web page when done.
      </div>
    </div>
  </div>

  <script>

    $(document).ready(function() {

      var user_id = getCookie("user_id");
      if (user_id != "") {
         $.get("/voter/" + user_id, function(data) {
            var empty = " ";
            console.log("get for " + user_id + " is " + data);
            document.getElementById('fullname').value = data.name;
            document.getElementById('email').value = data.email;
            document.getElementById('facebook').value = (data.facebook == undefined ? empty : data.facebook + empty);
            document.getElementById('twitter').value = (data.twitter == undefined ? empty : data.twitter + empty);
            var option = document.createElement("option");  option.text ="HIDDEN";
            $('#party').add(option);
            document.getElementById('evote').innerHTML = "<hidden>";
            $('#fullname').prop("disabled", true);
            $('#email').prop("disabled", true);
            $('#facebook').prop("disabled", true);
            $('#twitter').prop("disabled", true);
            $('#party').prop("disabled", true);
            $('#submit').prop( "disabled", true );
            document.getElementById('clear').style.display = "inline";
         });
      }

      $.ajaxSetup({
         contentType: "application/json; charset=utf-8"
      });
      $('#submit').click(function() {

        var voterinfo = {
            'name': $('#fullname').val(),
            'email': $('#email').val(),
            'facebook': $('#facebook').val(),
            'twitter': $('#switter').val(),
            'guid': guid(),
            'vote' : {
                'party': $('#party').val()
            }
        };
        var json = JSON.stringify(voterinfo);
        console.log("json stuff = '" + json + "'");
        $.post( "/voter",
                json,
                function( data ) {
                   console.log( data);
                   document.getElementById('evote').innerHTML = data.check_vote;
                   setCookie("user_id", data.insertedIds[0], 30);
                   setCookie("private_key", data.private_key, 30);
                   setCookie("guid", data.guid, 30);
                   $('#fullname').prop("disabled", true);
                   $('#email').prop("disabled", true);
                   $('#facebook').prop("disabled", true);
                   $('#twitter').prop("disabled", true);
                   $('#party').prop("disabled", true);
                   $('#submit').prop( "disabled", true );
                   document.getElementById('clear').style.display = "inline";
                }, "json")
        .fail(function( jqXHR, textStatus, errorThrown ) {
            alert("Error processing REST request: '" + textStatus + "'");
          });
      });

      $('#clear').click(function() {
         setCookie("user_id", "", 30);
         setCookie("private_key", "", 30);
         $('#fullname').prop("disabled", false);
         $('#email').prop("disabled", false);
         $('#facebook').prop("disabled", false);
         $('#twitter').prop("disabled", false);
         $('#party').prop("disabled", false);
         $('#submit').prop( "disabled", false );
         document.getElementById('clear').style.display = "none";
      });


    });

  </script>

</body>

</html>
